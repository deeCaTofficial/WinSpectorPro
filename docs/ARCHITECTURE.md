# Архитектура проекта WinSpector Pro

**Версия документа: 1.0.3**

Этот документ описывает высокоуровневую архитектуру, ключевые проектные решения и потоки данных в приложении WinSpector Pro.

## 1. Философия и цели

**WinSpector Pro** — это интеллектуальный инструмент для оптимизации Windows, построенный на двух ключевых принципах:

1.  **Персонализация через ИИ:** Вместо статических правил, ядро приложения использует генеративный ИИ (Google Gemini) для анализа уникального "цифрового отпечатка" системы и формирования контекстно-зависимого плана действий.
2.  **Безопасность по умолчанию:** Приоритетом является стабильность системы. Все операции выполняются только после создания точки восстановления, а решения ИИ проходят через многоуровневую систему валидации.

Проект следует **многослойной архитектуре (Layered Architecture)** для обеспечения низкой связанности компонентов (Low Coupling) и высокой степени их зацепления (High Cohesion).

## 2. Технологический стек

-   **Язык:** Python 3.10+
-   **GUI:** PyQt6
-   **Асинхронность:** `asyncio` в связке с `qasync` для интеграции с циклом событий PyQt.
-   **Системное взаимодействие:** `psutil`, `pywin32`, `wmi`.
-   **Изоляция процессов:** `concurrent.futures.ProcessPoolExecutor` для безопасных WMI-вызовов.
-   **ИИ-интеграция:** Google Generative AI API (`google-generativeai`).
-   **Данные и конфигурация:** `PyYAML` для модульной "Базы Знаний".
-   **Сборка:** PyInstaller, управляемый через динамически генерируемый `.spec` файл.

---

## 3. Структура слоев

Проект логически разделен на четыре основных слоя, каждый со своей зоной ответственности.

### 3.1. Слой Представления (Presentation Layer)

-   **Расположение:** `src/winspector/gui/`
-   **Ответственность:** Все, что касается отрисовки интерфейса и обработки действий пользователя. Этот слой **не содержит бизнес-логики**.
-   **Ключевые компоненты:**
    -   `MainWindow`: `QMainWindow`, выступающий в роли контроллера для страниц (виджетов).
    -   `widgets/`: Набор кастомных виджетов (`PulsingButton`, `NeuralBackgroundWidget`) для создания уникального пользовательского опыта.
    -   `TitleBar`: Кастомный заголовок окна для безрамочного дизайна.

### 3.2. Слой Приложения (Application Layer)

-   **Расположение:** `src/winspector/application.py`, `src/main.py`
-   **Ответственность:** "Клей", соединяющий все части приложения. Управляет жизненным циклом, инициализирует сервисы и обрабатывает глобальные события.
-   **Ключевые компоненты:**
    -   `Application`: Класс, инкапсулирующий всю логику запуска: настройка логирования, проверка прав администратора, защита от повторного запуска, создание асинхронного цикла и обработка необработанных исключений.
    -   `main.py`: Минималистичная точка входа, которая определяет системные пути и передает управление классу `Application`.

### 3.3. Слой Ядра и Бизнес-логики (Core / Business Logic Layer)

-   **Расположение:** `src/winspector/core/`
-   **Ответственность:** Оркестрация всего процесса оптимизации. Это "мозг" приложения.
-   **Ключевые компоненты:**
    -   `analyzer.py` (`WinSpectorCore`): Реализует паттерн **Фасад**, предоставляя один публичный метод (`run_autonomous_optimization`) для запуска сложного многошагового сценария. Управляет всеми аналитическими модулями.
    -   `modules/`: Набор независимых, узкоспециализированных модулей:
        -   `user_profiler.py`: Собирает многогранный "цифровой отпечаток" системы (ПО, оборудование, ярлыки, переменные окружения).
        -   `windows_optimizer.py`: Взаимодействует с ОС для изменения состояния служб, удаления UWP-приложений и создания точек восстановления.
        -   `smart_cleaner.py`: Реализует гибридную очистку (стандартную и интеллектуальную), а также удаление пустых директорий.
        -   `ai_analyzer.py`: Генерирует JSON-план оптимизации и содержит `_PlanValidator` для его многоуровневой проверки.
        -   `ai_communicator.py`: Отвечает за "диалоговые" задачи ИИ (определение профилей, генерация отчетов).
    -   `wmi_workers.py`: Набор функций, предназначенных для запуска в **изолированных процессах** для безопасного выполнения WMI-запросов.

### 3.4. Слой Данных (Data Layer)

-   **Расположение:** `src/winspector/data/`
-   **Ответственность:** Хранение и предоставление статических данных.
-   **Ключевые компоненты:**
    -   `data/knowledge_base/`: **Модульная База Знаний.** Директория с YAML-файлами, которые содержат правила и эвристики для ИИ и модулей. Это позволяет обновлять "интеллект" приложения без изменения кода.

---

## 4. Поток данных в сценарии автономной оптимизации

Основной сценарий работы приложения разделен на четкие асинхронные шаги, управляемые `WinSpectorCore`.

1.  **Инициация (GUI):**
    -   Пользователь нажимает кнопку "Начать".
    -   `MainWindow` вызывает метод `WinSpectorCore.run_autonomous_optimization()`.

2.  **Подготовка и Профилирование (Core):**
    -   Создается точка восстановления Windows.
    -   `UserProfiler` асинхронно собирает полный "снимок" системы (оборудование, ПО, ярлыки и т.д.).
    -   `AICommunicator` отправляет эти данные в ИИ и получает в ответ **список профилей** пользователя (например, `["Gamer", "Developer"]`).

3.  **Сбор данных для Плана (Core):**
    -   Параллельно запускаются две задачи:
        -   `WindowsOptimizer` собирает список **активных** служб и UWP-приложений.
        -   `SmartCleaner` сканирует диски и формирует отчет о потенциальном "мусоре".

4.  **Генерация и Валидация Плана (AIAnalyzer):**
    -   Все собранные данные, профили пользователя и отфильтрованная "База Знаний" отправляются в ИИ.
    -   ИИ возвращает **JSON-объект**, содержащий `action_plan` (действия со службами/UWP) и `cleanup_plan` (решения по очистке).
    -   Внутренний `_PlanValidator` проверяет этот план на соответствие правилам безопасности и релевантности профилям пользователя.

5.  **Выполнение (Core):**
    -   Параллельно запускаются два процесса:
        -   `WindowsOptimizer` выполняет одобренные действия из `action_plan`.
        -   `SmartCleaner` выполняет **стандартную очистку** и очистку по `cleanup_plan` от ИИ.
    -   После завершения `SmartCleaner` выполняет финальный проход для **удаления пустых директорий**.

6.  **Отчет (AICommunicator -> GUI):**
    -   Сводка по всем выполненным действиям (освобождено места, отключено служб) отправляется в ИИ.
    -   ИИ генерирует **персонализированный отчет** в формате Markdown с учетом профилей пользователя.
    -   Отчет отображается в `QTextBrowser` на главном окне.

7.  **Саморефлексия (Core, фоновая задача):**
    -   В фоновом режиме запускается задача, в которой ИИ анализирует всю сессию и генерирует предложения по улучшению самого приложения для разработчиков.